---
phase: 01-vdi-faq-ingestion
plan: 02
type: execute
wave: 1
depends_on: []
files_modified: [src/lib/pinecone/index.ts, src/app/api/chat/route.ts]
autonomous: true
---

<objective>
Integrate VDI FAQ into search and chat display.

Purpose: Add VDI FAQ as a searchable source in hybrid search and format it distinctly in chat responses.
Output: VDI FAQ content retrievable and clearly labeled when used as source.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-vdi-faq-ingestion/01-CONTEXT.md

# Files to modify:
@src/lib/pinecone/index.ts
@src/app/api/chat/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add VDI FAQ to hybrid search</name>
  <files>src/lib/pinecone/index.ts</files>
  <action>
Update searchHybrid function to include vdi_faq:

1. Add vdiFaqK parameter (default: 4) to searchHybrid signature:
   ```
   export async function searchHybrid(
     embedding: number[],
     legislationK: number = 8,
     rulingsK: number = 4,
     nutarimaiK: number = 2,
     vdiFaqK: number = 4  // NEW
   )
   ```

2. Add parallel query for vdi_faq (similar to nutarimai):
   ```
   index.query({
     vector: embedding,
     topK: vdiFaqK * 2,
     includeMetadata: true,
     filter: { docType: 'vdi_faq' },
   })
   ```

3. Filter vdi_faq results by score >= 0.65 (same threshold as nutarimai)

4. Add vdiFaq to merged results before sort

5. Update mapResult to include vdi_faq metadata fields (question, category)
  </action>
  <verify>npx tsc --noEmit</verify>
  <done>searchHybrid queries vdi_faq and returns results with proper metadata</done>
</task>

<task type="auto">
  <name>Task 2: Add VDI FAQ source formatting in chat</name>
  <files>src/app/api/chat/route.ts</files>
  <action>
Update chat route to handle vdi_faq sources:

1. Add vdiFaqCount to status message:
   ```
   const vdiFaqCount = searchResults.filter(r => r.metadata.docType === 'vdi_faq').length;
   if (vdiFaqCount > 0) parts.push(`${vdiFaqCount} VDI DUK`);
   ```

2. Add vdi_faq case to contextTexts mapping (around line 119):
   ```
   } else if (r.metadata.docType === 'vdi_faq') {
     const question = r.metadata.question || '';
     const category = r.metadata.category ? ` (${r.metadata.category})` : '';
     return `[VDI DUK${category}]\nKlausimas: ${question}\nAtsakymas: ${r.text}`;
   }
   ```

3. Add vdi_faq fields to metadata.sources mapping:
   ```
   question: r.metadata.question,
   category: r.metadata.category,
   ```

Note: "DUK" = "Dažniausiai Užduodami Klausimai" (FAQ in Lithuanian)
  </action>
  <verify>npx tsc --noEmit</verify>
  <done>VDI FAQ sources labeled as "[VDI DUK]" in chat context with question/answer format</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx tsc --noEmit` passes
- [ ] `npm run build` succeeds
- [ ] searchHybrid signature includes vdiFaqK parameter
- [ ] Chat route formats vdi_faq with "[VDI DUK]" label
</verification>

<success_criteria>

- VDI FAQ included in hybrid search queries
- VDI FAQ sources distinctly labeled in chat context
- TypeScript compiles without errors
- Build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/01-vdi-faq-ingestion/01-02-SUMMARY.md`
</output>
