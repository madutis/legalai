---
phase: 01.2-darbo-sauga
plan: 03
type: execute
wave: 2
depends_on: ["01.2-01", "01.2-02"]
files_modified: [src/types/index.ts, src/lib/topics.ts, src/app/page.tsx, src/app/chat/page.tsx, src/lib/pinecone/index.ts, src/lib/gemini/index.ts, src/components/chat/ChatMessage.tsx]
autonomous: true
---

<objective>
Add "Darbo sauga" topic and integrate safety sources into search and chat.

Purpose: Enable users to select occupational safety topic and get answers with DSS/VDI citations.
Output: Working "Darbo sauga" topic in UI with proper search and citation handling.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01.2-darbo-sauga/PRD.md
@.planning/phases/01.2-darbo-sauga/01.2-01-SUMMARY.md
@.planning/phases/01.2-darbo-sauga/01.2-02-SUMMARY.md

# Files to modify:
@src/types/index.ts
@src/lib/topics.ts
@src/app/page.tsx
@src/app/chat/page.tsx
@src/lib/pinecone/index.ts
@src/lib/gemini/index.ts
@src/components/chat/ChatMessage.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add safety topic type and config</name>
  <files>src/types/index.ts, src/lib/topics.ts</files>
  <action>
1. In src/types/index.ts, add 'safety' to ConsultationTopic union:
   ```typescript
   export type ConsultationTopic =
     | 'hiring'
     | 'termination'
     | 'leave'
     | 'wages'
     | 'disciplinary'
     | 'material'
     | 'contracts'
     | 'safety'  // NEW
     | 'other';
   ```

2. In src/lib/topics.ts, add safety topic config BEFORE 'other':
   ```typescript
   {
     id: 'safety',
     labelLT: 'Darbo sauga',
     labelEN: 'Occupational Safety',
     questions: [
       {
         id: 'safety_type',
         textLT: 'Koks darbo saugos klausimas?',
         options: [
           { value: 'training', labelLT: 'Instruktavimas/mokymai' },
           { value: 'incident', labelLT: 'Nelaimingas atsitikimas' },
           { value: 'remote', labelLT: 'Nuotolinis darbas' },
           { value: 'rules', labelLT: 'Taisyklės/dokumentai' },
           { value: 'general', labelLT: 'Bendri reikalavimai' },
         ],
       },
     ],
   },
   ```
  </action>
  <verify>npx tsc --noEmit passes</verify>
  <done>safety topic type and config added</done>
</task>

<task type="auto">
  <name>Task 2: Add safety topic to landing page UI</name>
  <files>src/app/page.tsx</files>
  <action>
1. Add safety icon to TOPIC_ICONS (shield icon for protection theme):
   ```typescript
   safety: (
     <svg className="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
       <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />
     </svg>
   ),
   ```

2. Add to TOPICS array BEFORE 'other':
   ```typescript
   { id: 'safety', label: 'Darbo sauga' },
   ```
  </action>
  <verify>npm run dev, navigate to /, see Darbo sauga topic option</verify>
  <done>Darbo sauga appears in landing page topic selection</done>
</task>

<task type="auto">
  <name>Task 3: Add safety topic to chat page</name>
  <files>src/app/chat/page.tsx</files>
  <action>
Find TOPIC_LABELS and TOPIC_ICONS in chat/page.tsx and add safety:

1. Add to TOPIC_LABELS:
   ```typescript
   safety: 'Darbo sauga',
   ```

2. Add to TOPIC_ICONS (same shield icon as landing page):
   ```typescript
   safety: (
     <svg className="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
       <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />
     </svg>
   ),
   ```

Note: Chat page uses w-4 h-4 for icons (smaller than landing page).
  </action>
  <verify>Select Darbo sauga topic on landing, chat page shows correct header</verify>
  <done>Chat page displays Darbo sauga topic correctly</done>
</task>

<task type="auto">
  <name>Task 4: Update LLM prompt for DSS citations</name>
  <files>src/lib/gemini/index.ts</files>
  <action>
Find the system prompt in generateRAGResponse or similar function. Add DSS citation instructions:

Add to citation guidance section:
```
- Jei šaltiniuose yra DSS įstatymo straipsnių (lawCode: DSS) - cituok: "Pagal DSS įstatymo X str..."
- Jei šaltiniuose yra VDI DSS dokumentų (category: safety) - cituok: "Pagal VDI metodines rekomendacijas..."
```

This ensures LLM knows how to cite the new safety sources alongside existing DK/LAT/VDI FAQ citations.
  </action>
  <verify>Read updated prompt, verify DSS citation instructions present</verify>
  <done>LLM prompt includes DSS citation guidance</done>
</task>

<task type="auto">
  <name>Task 5: Add DSS source link rendering</name>
  <files>src/components/chat/ChatMessage.tsx</files>
  <action>
Find the source link rendering section (where vdi_doc, vdi_faq, etc. are handled).

For legislation sources with lawCode=DSS, render differently:
- Title: "DSS Įstatymas, {articleNumber} str."
- Link: e-tar.lt URL (or no link if sourceUrl not available)

Check existing legislation handling - if it just shows "Darbo kodeksas", add condition:
```typescript
if (citation.docType === 'legislation') {
  const lawLabel = citation.lawCode === 'DSS' ? 'DSS Įstatymas' : 'Darbo kodeksas';
  // render with lawLabel
}
```

Note: Citation type needs lawCode field - verify it's passed through from search results.
  </action>
  <verify>Ask safety question, see "DSS Įstatymas" in source chips</verify>
  <done>DSS sources display with correct label in chat</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds
- [ ] Darbo sauga topic visible on landing page
- [ ] Darbo sauga label correct in chat header
- [ ] Query "darbdavio pareigos saugai" returns DSS results
- [ ] Query "kaip instruktuoti darbuotojus" returns VDI safety results
- [ ] Citations show "DSS Įstatymas" and "VDI DSS" correctly
</verification>

<success_criteria>
- All tasks completed
- Full flow works: select Darbo sauga topic → ask question → get answer with safety citations
- No build errors
- DSS and VDI safety sources properly cited
</success_criteria>

<output>
After completion, create `.planning/phases/01.2-darbo-sauga/01.2-03-SUMMARY.md`
</output>
