---
phase: 01.2-darbo-sauga
plan: 02
type: execute
wave: 1
depends_on: []
files_modified: [scripts/discover-vdi-safety.ts, scripts/ingest-vdi-safety.ts]
autonomous: true
---

<objective>
Discover and ingest VDI occupational safety methodological recommendations.

Purpose: Add VDI DSS guidance documents (instruktavimas, nuotolinis darbas, smurtas, etc.) to knowledge base.
Output: Tier 1+2 safety documents chunked and embedded in Pinecone with docType=vdi_doc, category=safety.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01.2-darbo-sauga/PRD.md

# Existing patterns to follow:
@scripts/discover-vdi-content.ts
@scripts/ingest-vdi-docs.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create VDI safety discovery script</name>
  <files>scripts/discover-vdi-safety.ts</files>
  <action>
Create discovery script for VDI methodological recommendations (MR_grid.aspx).

Source: https://www.vdi.lt/Forms/MR_grid.aspx (245 documents, paginated)

Follow discover-vdi-content.ts patterns:
- Lazy-init GenAI for LLM classification
- Support --dry-run flag
- Use cheerio for HTML parsing

Script structure:
1. Fetch paginated list from MR_grid.aspx (parse __VIEWSTATE for ASP.NET postback)
   - Page 1: direct GET
   - Pages 2+: POST with __EVENTTARGET=ctl00$MainContent$GridView1, __EVENTARGUMENT=Page$N
2. For each page, extract document rows:
   - Title (from link text)
   - PDF URL (from href, prepend https://www.vdi.lt if relative)
   - Date (from table cell)
3. Filter by keywords for safety relevance:
   - Tier 1 keywords: instruktav*, nuotolin*, smurt*, nelaiming*, atsitik*, moky*
   - Tier 2 keywords: saugos, sveikat*, rizik*, darbo viet*
4. For matching docs, fetch PDF and extract text preview (first 2000 chars)
5. LLM classify with Gemini 2.0 Flash:
   ```
   Tier 1 (essential): Employee training/instruction, remote work safety, harassment prevention, incident investigation
   Tier 2 (useful): General workplace safety, risk assessment basics
   Tier 3 (skip): Industry-specific technical standards, detailed inspection procedures
   ```
6. Save manifest to data/vdi-safety-manifest.json

Target: ~10-15 Tier 1+2 documents from the 245 total.
  </action>
  <verify>npx tsx scripts/discover-vdi-safety.ts --dry-run shows document extraction</verify>
  <done>Discovery script parses MR_grid pagination and extracts safety-relevant docs</done>
</task>

<task type="auto">
  <name>Task 2: Create VDI safety ingestion script</name>
  <files>scripts/ingest-vdi-safety.ts</files>
  <action>
Create ingestion script following ingest-vdi-docs.ts pattern exactly.

Differences from ingest-vdi-docs.ts:
- Read from data/vdi-safety-manifest.json
- Add category: 'safety' to metadata
- Vector ID format: `vdi-safety-{sanitizedDocId}-chunk-{chunkIndex}`

Metadata structure:
```
{
  docId: `vdi-safety-{sanitizedDocId}`,
  docType: 'vdi_doc',
  category: 'safety',  // NEW: distinguish from other vdi_doc
  title: string,
  text: string (max 8000 chars),
  chunkIndex: number,
  totalChunks: number,
  sourceUrl: string,
  tier: number,
  topics: string
}
```

Chunking: 1500 chars with 200 char overlap (same as vdi-docs).
Rate limiting: 100ms every 5 embeddings, batch upsert 100 vectors.
  </action>
  <verify>npx tsx scripts/ingest-vdi-safety.ts --dry-run shows chunk creation</verify>
  <done>Ingestion script processes safety manifest with correct metadata</done>
</task>

<task type="auto">
  <name>Task 3: Run discovery and ingestion</name>
  <files>scripts/discover-vdi-safety.ts, scripts/ingest-vdi-safety.ts</files>
  <action>
Run both scripts sequentially:

1. Discovery:
```bash
npx tsx scripts/discover-vdi-safety.ts
```
Expected: 10-15 Tier 1+2 documents in manifest

Key documents to verify in manifest:
- Darbuotojų instruktavimo tvarka (instruktavimas)
- Nuotolinio darbo sauga
- Psichologinio smurto prevencija
- Kaip ištirti nelaimingą atsitikimą

2. Ingestion:
```bash
npx tsx scripts/ingest-vdi-safety.ts
```
Expected: 50-100 chunks ingested (depends on document lengths)

If discovery finds fewer documents than expected, that's OK - quality over quantity.
  </action>
  <verify>Both scripts complete, manifest has Tier 1+2 docs, Pinecone has safety chunks</verify>
  <done>VDI safety documents ingested with category=safety metadata</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Discovery finds key safety documents (instruktavimas, nuotolinis, smurtas)
- [ ] Manifest saved to data/vdi-safety-manifest.json
- [ ] Ingestion completes without errors
- [ ] Pinecone contains vdi_doc vectors with category=safety
</verification>

<success_criteria>
- All tasks completed
- 10+ safety documents classified as Tier 1 or 2
- Documents chunked and embedded in Pinecone
- category=safety metadata distinguishes from other VDI docs
</success_criteria>

<output>
After completion, create `.planning/phases/01.2-darbo-sauga/01.2-02-SUMMARY.md`
</output>
