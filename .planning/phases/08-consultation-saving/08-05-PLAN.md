---
phase: 08-consultation-saving
plan: 05
type: execute
wave: 3
depends_on: ["08-03"]
files_modified:
  - src/components/chat/ChatSidebar.tsx
  - src/components/chat/SavePreferencePrompt.tsx
  - src/app/chat/page.tsx
  - src/app/terms/page.tsx
  - src/components/subscription/SubscriptionModal.tsx
  - src/app/account/page.tsx
  - src/lib/firebase/firestore.ts
autonomous: true

must_haves:
  truths:
    - "Save-by-default toggle exists in sidebar"
    - "Post-subscription prompt appears after first payment"
    - "T&Cs updated with chat saving policy"
    - "Upgrade modal mentions chat saving benefit"
  artifacts:
    - path: "src/components/chat/SavePreferencePrompt.tsx"
      provides: "Post-subscription prompt for save preference"
      exports: ["SavePreferencePrompt"]
    - path: "src/app/terms/page.tsx"
      provides: "Updated T&Cs with chat saving section"
      contains: "konsultaciju issaugojimas"
    - path: "src/components/subscription/SubscriptionModal.tsx"
      provides: "Upgrade modal with chat saving mention"
      contains: "issaugoti"
  key_links:
    - from: "src/components/chat/ChatSidebar.tsx"
      to: "src/hooks/useSavePreference.ts"
      via: "reads and toggles save preference"
      pattern: "useSavePreference"
    - from: "src/app/chat/page.tsx"
      to: "src/components/chat/SavePreferencePrompt.tsx"
      via: "shows prompt after checkout success"
      pattern: "SavePreferencePrompt"
---

<objective>
Add settings UI, post-subscription prompt, and update copy across the app.

Purpose: Users need control over save behavior. New subscribers should set their preference. Copy should accurately reflect that chats can now be saved.

Output: Toggle in sidebar, post-subscription prompt, updated T&Cs and upgrade modal copy.
</objective>

<execution_context>
@/Users/mad/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mad/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/08-consultation-saving/08-CONTEXT.md
@.planning/phases/08-consultation-saving/08-RESEARCH.md

# From Plan 03
@src/hooks/useSavePreference.ts
@src/components/chat/ChatSidebar.tsx

# Existing
@src/app/chat/page.tsx
@src/app/terms/page.tsx
@src/components/subscription/SubscriptionModal.tsx
@src/app/account/page.tsx
@src/lib/firebase/firestore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add save preference toggle to sidebar</name>
  <files>src/components/chat/ChatSidebar.tsx, src/lib/firebase/firestore.ts</files>
  <action>
1. Update firestore.ts to add saveByDefault field handling:

```typescript
// Add to UserDocument interface
export interface UserDocument {
  // ... existing fields
  saveByDefault?: boolean;  // undefined treated as true
}

// Add helper functions
export async function getSaveByDefault(uid: string): Promise<boolean> {
  const db = getFirebaseFirestore();
  const userRef = doc(db, 'users', uid);
  const snapshot = await getDoc(userRef);
  // Default true per CONTEXT.md
  return snapshot.exists() ? (snapshot.data().saveByDefault ?? true) : true;
}

export async function setSaveByDefault(uid: string, value: boolean): Promise<void> {
  const db = getFirebaseFirestore();
  const userRef = doc(db, 'users', uid);
  await setDoc(userRef, { saveByDefault: value }, { merge: true });
}
```

2. Add toggle to ChatSidebar footer:

```typescript
// In SidebarFooter section
<SidebarFooter>
  <div className="px-3 py-2 border-t border-border">
    <div className="flex items-center justify-between">
      <div className="flex items-center gap-2 text-sm text-muted-foreground">
        <Save className="w-4 h-4" />
        <span>Saugoti pagal numatyma</span>
      </div>
      <Switch
        checked={saveByDefault}
        onCheckedChange={handleToggle}
        disabled={!isSubscribed}
      />
    </div>
    {!isSubscribed && (
      <p className="text-xs text-muted-foreground mt-1">
        Tik prenumeratoriams
      </p>
    )}
  </div>
</SidebarFooter>
```

Use shadcn Switch component. Show disabled state for non-subscribers.
  </action>
  <verify>Toggle visible in sidebar footer, changes persist after refresh</verify>
  <done>Save preference toggle in sidebar, persists to Firestore</done>
</task>

<task type="auto">
  <name>Task 2: Create post-subscription save preference prompt</name>
  <files>src/components/chat/SavePreferencePrompt.tsx, src/app/chat/page.tsx</files>
  <action>
1. Create SavePreferencePrompt.tsx:

Modal shown AFTER checkout success modal closes (or replaces it).

```typescript
interface SavePreferencePromptProps {
  isOpen: boolean;
  onClose: (saveByDefault: boolean) => void;
}
```

Content (Lithuanian):
- Title: "Konsultaciju issaugojimas"
- Body: "Ar norite, kad jusu konsultacijos butu saugomos automatiskai? Galite pakeisti bet kada nustatymuose."
- Options:
  - "Taip, saugoti" (primary) - sets saveByDefault=true
  - "Ne, nesaugoti" (outline) - sets saveByDefault=false

Simple modal, follow DeleteAccountModal pattern.

2. Update page.tsx:
- After checkout success modal closes, check if this is first subscription (no saveByDefault set)
- If so, show SavePreferencePrompt
- On close, save preference to Firestore

```typescript
const [showSavePrompt, setShowSavePrompt] = useState(false);

// After checkout success
useEffect(() => {
  if (showCheckoutSuccess) {
    // When success modal closes, show save prompt if first time
  }
}, [showCheckoutSuccess]);
```
  </action>
  <verify>Complete checkout, close success modal, save preference prompt appears</verify>
  <done>Post-subscription prompt shows and saves preference</done>
</task>

<task type="auto">
  <name>Task 3: Update copy in T&Cs and upgrade modal</name>
  <files>src/app/terms/page.tsx, src/components/subscription/SubscriptionModal.tsx</files>
  <action>
1. Update terms/page.tsx:

Add new section about chat saving (after existing sections, before account deletion):

```tsx
<section id="konsultaciju-issaugojimas">
  <h2 className="font-serif text-xl font-semibold mb-4">7. Konsultaciju issaugojimas</h2>
  <TldrBox>Jusu konsultacijos saugomos tik jei pasirenkate. Galite bet kada istrinti.</TldrBox>
  <div className="space-y-3 text-foreground/80">
    <p>
      Prenumeratoriai gali pasirinkti saugoti konsultaciju istorija.
      Issaugotos konsultacijos prieinamos tik jums ir gali buti istrintos bet kada.
    </p>
    <p>
      Jei nepasirenkate saugoti, konsultacijos duomenys nera issaugomi po sesijos pabaigos.
    </p>
  </div>
</section>
```

Update section numbering if needed. Adjust existing "Duomenu tvarkymas" section if it mentioned "we don't save chats".

2. Update SubscriptionModal.tsx:

Add chat saving as a benefit (minimal mention, per CONTEXT.md):

In the benefits list, add:
```tsx
<li className="flex items-center gap-2">
  <Check className="w-4 h-4 text-gold" />
  <span>Konsultaciju istorijos issaugojimas</span>
</li>
```

Place after existing benefits, not highlighted (just one item among others).
  </action>
  <verify>
- Visit /terms - new section visible
- Open subscription modal - chat saving mentioned in benefits
</verify>
  <done>T&Cs and upgrade modal updated with chat saving copy</done>
</task>

</tasks>

<verification>
- `npm run build` passes
- Sidebar toggle: visible, works, persists
- Post-subscription prompt: appears after first checkout success
- T&Cs: new section about chat saving
- Upgrade modal: chat saving in benefits list
</verification>

<success_criteria>
- Save-by-default toggle in sidebar footer
- Toggle disabled for non-subscribers with explanation
- Post-subscription prompt appears after first payment
- T&Cs have chat saving section (section 7)
- Subscription modal lists chat saving as benefit
</success_criteria>

<output>
After completion, create `.planning/phases/08-consultation-saving/08-05-SUMMARY.md`
</output>
