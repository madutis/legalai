---
phase: 01.3-fire-safety-law
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [scripts/ingest-pss-istatymas.ts, src/lib/pinecone/index.ts, src/app/api/chat/route.ts, src/components/chat/ChatInterface.tsx]
autonomous: true
---

<objective>
Ingest Priešgaisrinės saugos įstatymas (Fire Safety Law) as legislation source.

Purpose: Add fire safety law to knowledge base for fire safety Q&A with article citations.
Output: 22 PSS articles embedded in Pinecone with docType=legislation, lawCode=PSS.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/SOURCES.md

# Existing patterns to follow:
@scripts/ingest-dss-istatymas.ts
@src/lib/pinecone/index.ts
@src/app/api/chat/route.ts
@src/components/chat/ChatInterface.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PSS ingestion script</name>
  <files>scripts/ingest-pss-istatymas.ts</files>
  <action>
Create ingestion script for Priešgaisrinės saugos įstatymas from e-tar.lt.

Source URL: https://www.e-tar.lt/portal/lt/legalAct/TAR.9CBB77180BFE/asr

Copy from ingest-dss-istatymas.ts and modify:
- E-TAR document ID: TAR.9CBB77180BFE
- lawCode: 'PSS'
- Update sourceUrl to PSS e-tar link
- Adjust article parsing if structure differs

Script should:
1. Fetch HTML from e-tar.lt
2. Parse article structure (22 articles)
3. Extract article number, title, and text
4. Generate embeddings with text-embedding-004
5. Upsert to Pinecone with metadata:
   - docType: 'legislation'
   - lawCode: 'PSS'
   - articleNumber, articleTitle
   - sourceUrl pointing to e-tar

Support --dry-run flag for testing without Pinecone writes.
  </action>
  <verification>
Run with --dry-run to verify parsing:
```bash
npx tsx scripts/ingest-pss-istatymas.ts --dry-run
```
Should output ~22 articles with correct structure.
  </verification>
</task>

<task type="auto">
  <name>Task 2: Update context labeling and source display</name>
  <files>src/app/api/chat/route.ts, src/components/chat/ChatInterface.tsx</files>
  <action>
1. In src/app/api/chat/route.ts, context labeling already handles lawCode.
   Verify it works for PSS - the existing code should handle it:
   ```typescript
   const lawLabel = (r.metadata as any).lawCode === 'DSS' ? 'DSS ĮSTATYMAS' :
                    (r.metadata as any).lawCode === 'PSS' ? 'PRIEŠGAISRINĖS SAUGOS ĮSTATYMAS' :
                    'DARBO KODEKSAS';
   ```

2. In src/components/chat/ChatInterface.tsx, update getSourceUrl() for PSS:
   ```typescript
   // In getSourceUrl function, add PSS document ID
   if (source.docType === 'legislation' && source.articleNumber) {
     let eTarDocId = 'f6d686707e7011e6b969d7ae07280e89'; // DK default
     if (source.lawCode === 'DSS') eTarDocId = 'TAR.95C79D036AA4';
     if (source.lawCode === 'PSS') eTarDocId = 'TAR.9CBB77180BFE';
     return `https://www.e-tar.lt/portal/lt/legalAct/${eTarDocId}/asr#part_${source.articleNumber}`;
   }
   ```

3. In formatSource(), update label handling for PSS:
   ```typescript
   if (source.docType === 'legislation' && source.articleNumber) {
     const lawLabel = source.lawCode === 'DSS' ? 'DSS' :
                      source.lawCode === 'PSS' ? 'PSS' : 'DK';
     return `${lawLabel} ${source.articleNumber} str.`;
   }
   ```
  </action>
  <verification>
Build project to verify no type errors:
```bash
npm run build
```
  </verification>
</task>

<task type="auto">
  <name>Task 3: Run ingestion and verify</name>
  <files>None (execution only)</files>
  <action>
1. Run the ingestion script (not dry-run):
   ```bash
   npx tsx scripts/ingest-pss-istatymas.ts
   ```

2. Verify in Pinecone that PSS articles exist:
   - Should have ~22 vectors with lawCode=PSS
   - Each should have articleNumber, articleTitle, sourceUrl

3. Test with a fire safety query to verify search returns PSS articles
  </action>
  <verification>
Test search for fire safety query returns PSS articles in results.
  </verification>
</task>

</tasks>

<success_criteria>
- [ ] PSS ingestion script created following DSS pattern
- [ ] 22 PSS articles ingested to Pinecone with lawCode=PSS
- [ ] Context labeling shows [PRIEŠGAISRINĖS SAUGOS ĮSTATYMAS, X str.]
- [ ] Source pills show "PSS X str." with correct e-tar links
- [ ] Fire safety queries return PSS articles
</success_criteria>
