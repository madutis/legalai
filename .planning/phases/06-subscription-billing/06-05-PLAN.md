---
phase: 06-subscription-billing
plan: 05
type: execute
wave: 3
depends_on: ["06-04"]
files_modified: [src/lib/firebase/firestore.ts, src/app/api/chat/route.ts, src/components/subscription/UsageWarning.tsx, src/components/subscription/UsageLimitModal.tsx, src/components/chat/ChatInterface.tsx]
autonomous: true
---

<objective>
Implement fair use limits: 50 questions/day with soft warning at 5 remaining and hard block at limit.

Purpose: Prevent abuse while maintaining good UX for normal users.
Output: Usage tracking, warning toast at 45 questions, block modal at 50.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-subscription-billing/06-CONTEXT.md

@src/app/api/chat/route.ts
@src/lib/firebase/firestore.ts
@src/components/chat/ChatInterface.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add usage tracking functions to Firestore</name>
  <files>src/lib/firebase/firestore.ts</files>
  <action>
Add usage tracking functions:

```typescript
// Get today's usage count for a user
export async function getTodayUsage(uid: string): Promise<number>
// Returns questionCount from users/{uid}/usage/{YYYY-MM-DD} or 0 if not exists
// Use UTC date for consistency

// Increment usage count
export async function incrementUsage(uid: string): Promise<void>
// Updates users/{uid}/usage/{YYYY-MM-DD} with:
// - questionCount: increment(1)
// - lastQuestionAt: serverTimestamp()
// Uses setDoc with merge: true (creates doc if not exists)

// Check if user can send message
export async function checkUsageLimit(uid: string): Promise<{
  allowed: boolean;
  remaining: number;
  showWarning: boolean;
}>
// Returns:
// - allowed: count < 50
// - remaining: 50 - count
// - showWarning: count >= 45 (5 or fewer remaining)
```

Helper to format today's date as YYYY-MM-DD in UTC:
```typescript
function getTodayKey(): string {
  return new Date().toISOString().split('T')[0];
}
```

Import `increment` and `serverTimestamp` from firebase/firestore.
  </action>
  <verify>Build passes: `npm run build`</verify>
  <done>Usage tracking functions ready for API and client use.</done>
</task>

<task type="auto">
  <name>Task 2: Add usage check to chat API</name>
  <files>src/app/api/chat/route.ts</files>
  <action>
Update chat API to enforce usage limits:

1. Import `checkUsageLimit`, `incrementUsage` from firestore.ts
2. Get authenticated user (should already be doing this for subscription check)

At the START of the POST handler (before processing message):
1. Call `checkUsageLimit(uid)`
2. If `!allowed`, return 429 with JSON: `{ error: 'limit_reached', remaining: 0 }`
3. Include `showWarning` and `remaining` in successful response headers or response body

After successfully processing message (before returning response):
1. Call `incrementUsage(uid)` - fire and forget, don't block response

For streaming responses, you may need to handle this differently:
- Check limit before starting stream
- Increment after stream starts (user committed to question)
- Return limit info in initial stream data or headers

If the API uses streaming, add to the first chunk or use response headers:
- `X-Usage-Remaining: {remaining}`
- `X-Usage-Warning: true` (if showWarning)

Or include in non-streaming response body alongside the answer.
  </action>
  <verify>Build passes: `npm run build`</verify>
  <done>Chat API enforces 50 questions/day limit and returns usage info.</done>
</task>

<task type="auto">
  <name>Task 3: Create usage warning and limit components</name>
  <files>src/components/subscription/UsageWarning.tsx, src/components/subscription/UsageLimitModal.tsx, src/components/chat/ChatInterface.tsx</files>
  <action>
1. Create `src/components/subscription/UsageWarning.tsx`:
Toast notification shown when 5 or fewer questions remaining.

```typescript
interface UsageWarningProps {
  remaining: number;
  onDismiss: () => void;
}
```

Design:
```
┌─────────────────────────────────────┐
│ ⚠ Liko {remaining} klausimai šiandien │
└─────────────────────────────────────┘
```

- Fixed position bottom-right or top-right
- Auto-dismiss after 5 seconds
- Amber/warning color scheme (bg-amber-100, text-amber-800)
- Small X to dismiss manually

2. Create `src/components/subscription/UsageLimitModal.tsx`:
Modal shown when daily limit reached.

```typescript
interface UsageLimitModalProps {
  isOpen: boolean;
  onClose: () => void;
}
```

Design:
```
┌─────────────────────────────────────┐
│  Dienos limitas pasiektas           │
│                                     │
│  Galite užduoti daugiau klausimų    │
│  nuo vidurnakčio (UTC).             │
│                                     │
│  [Supratau]                         │
└─────────────────────────────────────┘
```

- Modal similar to SubscriptionModal but simpler
- Single "Supratau" button that closes modal
- Informational, not aggressive

3. Update `src/components/chat/ChatInterface.tsx`:
- Add state for warning: `showUsageWarning`, `usageRemaining`
- Add state for limit modal: `showLimitModal`

After sending message and getting response:
- Check response for usage info (headers or body)
- If `showWarning` is true and remaining <= 5, show UsageWarning toast
- If response is 429 (limit_reached), show UsageLimitModal and prevent further sends

On 429 response:
- Don't add message to chat
- Show limit modal
- Disable input until modal dismissed (input stays disabled until next day anyway)
  </action>
  <verify>Build passes: `npm run build`</verify>
  <done>Usage warning toast and limit modal integrated into chat flow.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] Usage tracked in Firestore subcollection
- [ ] Chat API returns 429 at limit
- [ ] Warning toast appears at 45+ questions
- [ ] Limit modal appears at 50 questions
</verification>

<success_criteria>

- All tasks completed
- 50 questions/day limit enforced server-side
- Warning shown when 5 or fewer remaining
- Limit modal shown when limit reached
- Usage persisted in Firestore for logging/analytics
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/06-subscription-billing/06-05-SUMMARY.md`
</output>
