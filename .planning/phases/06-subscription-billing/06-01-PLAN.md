---
phase: 06-subscription-billing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/lib/stripe/client.ts, src/app/api/stripe/create-checkout-session/route.ts, src/app/api/stripe/create-portal-session/route.ts, src/app/api/stripe/webhook/route.ts]
autonomous: true
user_setup:
  - service: stripe
    why: "Payment processing requires dashboard configuration"
    env_vars:
      - name: STRIPE_SECRET_KEY
        source: "Stripe Dashboard → Developers → API keys → Secret key"
      - name: NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY
        source: "Stripe Dashboard → Developers → API keys → Publishable key"
      - name: STRIPE_PRICE_MONTHLY
        source: "Stripe Dashboard → Products → LegalAI → Monthly price ID"
      - name: STRIPE_PRICE_YEARLY
        source: "Stripe Dashboard → Products → LegalAI → Yearly price ID"
    dashboard_config:
      - task: "Create product and prices"
        location: "Stripe Dashboard → Products → Add product"
        details: "Name: LegalAI Subscription, Prices: €29/month, €299/year"
      - task: "Enable Stripe Tax"
        location: "Stripe Dashboard → Settings → Tax"
        details: "Add business address (Lithuania), set tax behavior to exclusive"
      - task: "Configure Customer Portal"
        location: "Stripe Dashboard → Settings → Billing → Customer portal"
        details: "Enable: Cancel, Update payment, View invoices. Disable: Switch plans"
    local_dev:
      - "stripe listen --forward-to localhost:3000/api/stripe/webhook"
---

<objective>
Create Stripe API routes for subscription checkout, customer portal, and webhook handling.

Purpose: Enable payment flow - users can subscribe, manage their subscription, and our system stays in sync with Stripe.
Output: Three API routes ready for frontend integration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-subscription-billing/06-CONTEXT.md

@src/lib/firebase/firestore.ts
@src/lib/firebase/config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Stripe client and checkout session endpoint</name>
  <files>src/lib/stripe/client.ts, src/app/api/stripe/create-checkout-session/route.ts</files>
  <action>
1. Create `src/lib/stripe/client.ts`:
   - Initialize Stripe with `STRIPE_SECRET_KEY`
   - Export stripe instance

2. Create `src/app/api/stripe/create-checkout-session/route.ts`:
   - POST endpoint accepting `{ priceType: 'monthly' | 'yearly' }`
   - Get authenticated user from Firebase Auth (verify ID token from Authorization header)
   - Get or create Stripe customer:
     - Check Firestore `users/{uid}` for `stripeCustomerId`
     - If not exists, create customer with `stripe.customers.create({ email, metadata: { firebaseUid } })`
     - Save `stripeCustomerId` to Firestore
   - Create Checkout Session with:
     - `mode: 'subscription'`
     - `customer: stripeCustomerId`
     - `line_items: [{ price: priceId, quantity: 1 }]`
     - `success_url: ${origin}/chat?checkout=success`
     - `cancel_url: ${origin}/account?checkout=canceled`
     - `allow_promotion_codes: true`
     - `billing_address_collection: 'auto'`
     - `tax_id_collection: { enabled: true }`
     - `automatic_tax: { enabled: true }`
   - Return `{ url: session.url }`

Use `STRIPE_PRICE_MONTHLY` and `STRIPE_PRICE_YEARLY` env vars for price IDs.
Return 401 if not authenticated, 400 if invalid priceType.
  </action>
  <verify>Build passes: `npm run build`</verify>
  <done>Checkout session endpoint returns Stripe URL for valid requests.</done>
</task>

<task type="auto">
  <name>Task 2: Create portal session endpoint</name>
  <files>src/app/api/stripe/create-portal-session/route.ts</files>
  <action>
Create `src/app/api/stripe/create-portal-session/route.ts`:
- POST endpoint (no body needed)
- Get authenticated user from Firebase Auth
- Get `stripeCustomerId` from Firestore `users/{uid}`
- If no stripeCustomerId, return 400 "No subscription found"
- Create Portal Session with:
  - `customer: stripeCustomerId`
  - `return_url: ${origin}/account`
- Return `{ url: session.url }`

Return 401 if not authenticated.
  </action>
  <verify>Build passes: `npm run build`</verify>
  <done>Portal session endpoint returns Stripe Portal URL.</done>
</task>

<task type="auto">
  <name>Task 3: Create webhook handler</name>
  <files>src/app/api/stripe/webhook/route.ts</files>
  <action>
Create `src/app/api/stripe/webhook/route.ts`:
- POST endpoint
- Read raw body with `req.text()` (not json - needed for signature verification)
- Get `stripe-signature` header
- Verify webhook signature with `stripe.webhooks.constructEvent(body, signature, STRIPE_WEBHOOK_SECRET)`
- Return 400 if signature invalid

Handle events:

1. `checkout.session.completed`:
   - Get customer ID from event
   - Find user by `stripeCustomerId` in Firestore (or use metadata.firebaseUid if set)
   - Retrieve subscription details from `session.subscription`
   - Update Firestore user document with:
     ```
     subscription: {
       status: 'active',
       stripeSubscriptionId: subscription.id,
       priceId: subscription.items.data[0].price.id,
       currentPeriodEnd: new Date(subscription.current_period_end * 1000),
       cancelAtPeriodEnd: false
     }
     ```

2. `customer.subscription.updated`:
   - Find user by subscription's customer ID
   - Update subscription fields (status, currentPeriodEnd, cancelAtPeriodEnd)
   - Map Stripe status: 'active', 'past_due', 'canceled' → same; others → 'expired'

3. `customer.subscription.deleted`:
   - Find user by customer ID
   - Set `subscription.status: 'expired'`

4. `invoice.payment_failed`:
   - Find user by customer ID
   - Set `subscription.status: 'past_due'`

Always return 200 after processing (even on error - log error but don't fail webhook).

Export config to disable body parsing: `export const config = { api: { bodyParser: false } }` - but for App Router, use `export const runtime = 'nodejs'` if needed.
  </action>
  <verify>Build passes: `npm run build`</verify>
  <done>Webhook handler processes all 4 event types and updates Firestore.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] All three API routes exist and export POST handlers
- [ ] Stripe client properly initialized
- [ ] Webhook verifies signatures before processing
</verification>

<success_criteria>

- All tasks completed
- Checkout endpoint creates valid Stripe sessions
- Portal endpoint creates customer portal sessions
- Webhook handles checkout.session.completed, subscription.updated, subscription.deleted, invoice.payment_failed
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/06-subscription-billing/06-01-SUMMARY.md`
</output>
