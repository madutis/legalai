---
phase: 06-subscription-billing
plan: 04
type: execute
wave: 2
depends_on: ["06-01", "06-02"]
files_modified: [src/components/subscription/SubscriptionModal.tsx, src/app/chat/page.tsx]
autonomous: true
---

<objective>
Create subscription modal and gate chat access for expired trial/subscription users.

Purpose: Users with expired trial or subscription should see a modest prompt to subscribe when trying to use chat.
Output: SubscriptionModal component and chat page gating logic.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-subscription-billing/06-CONTEXT.md

@src/app/chat/page.tsx
@src/contexts/SubscriptionContext.tsx
@src/components/ui/button.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SubscriptionModal component</name>
  <files>src/components/subscription/SubscriptionModal.tsx</files>
  <action>
Create `src/components/subscription/SubscriptionModal.tsx`:

A modest, centered modal (NOT full-screen takeover) that prompts subscription.

Props:
```typescript
interface SubscriptionModalProps {
  isOpen: boolean;
  onClose: () => void;
}
```

Design (as per CONTEXT.md):
```
┌─────────────────────────────────────┐
│                          [X]        │
│                                     │
│  Bandomasis laikotarpis baigėsi     │
│                                     │
│  Tęskite naudojimąsi LegalAI        │
│                                     │
│  ○ €29/mėn. + PVM                   │
│  ● €299/m. + PVM (sutaupote 14%)    │
│                                     │
│  [Prenumeruoti]                     │
│                                     │
└─────────────────────────────────────┘
```

Implementation:
1. Backdrop with slight opacity (bg-black/50), click outside dismisses
2. Centered modal card (max-w-sm)
3. X button in top-right to dismiss
4. Radio buttons for plan selection (default to yearly - better value)
5. Single "Prenumeruoti" CTA button
6. Loading state on button while API call in progress

On subscribe click:
1. Call `/api/stripe/create-checkout-session` with selected priceType
2. Redirect to returned URL

Style:
- Use existing design tokens (bg-card, border-border, text-foreground, etc.)
- Modal should feel modest, not aggressive
- Radio buttons: custom styled or use simple HTML radio with labels
- Animate in with fade/scale (animate-fade-up or similar)
  </action>
  <verify>Build passes: `npm run build`</verify>
  <done>SubscriptionModal renders with plan selection and subscribe action.</done>
</task>

<task type="auto">
  <name>Task 2: Add subscription gating to chat page</name>
  <files>src/app/chat/page.tsx</files>
  <action>
Update chat page to gate access for expired users:

1. Import `useSubscription` and `SubscriptionModal`
2. Get `status` from useSubscription()
3. Add state for modal visibility: `const [showSubscriptionModal, setShowSubscriptionModal] = useState(false)`

Gating logic:
- If `status === 'loading'`: Show existing loading state
- If `status === 'trial_expired' || status === 'subscription_expired'`:
  - Show the SubscriptionModal (set showSubscriptionModal to true on mount via useEffect)
  - Modal is dismissable but will reappear if they try to interact with chat
- If `status === 'allowed' || status === 'pre_trial'`: Normal chat access

Also handle `?checkout=success` query param:
- If URL has `?checkout=success`, show brief "Apmokėjimas sėkmingas!" toast or message
- This is optimistic unlock - user just paid, assume success
- Remove query param from URL after showing (use router.replace)

Modal behavior:
- Opens automatically when status is expired
- Dismissable with X or clicking outside
- If dismissed, user sees chat but can't send messages (input disabled or shows modal again on submit attempt)

For simplicity: Just show modal overlay on expired status. User can dismiss but status won't change until they subscribe and webhook fires.
  </action>
  <verify>Build passes: `npm run build`</verify>
  <done>Chat page gates access for expired users with subscription modal.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] SubscriptionModal renders correctly with plan selection
- [ ] Modal appears for trial_expired and subscription_expired status
- [ ] Subscribe button redirects to Stripe Checkout
- [ ] checkout=success query param handled
</verification>

<success_criteria>

- All tasks completed
- Modal is modest and dismissable
- Plan selection works (monthly/yearly radio)
- Expired users see modal on chat page
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/06-subscription-billing/06-04-SUMMARY.md`
</output>
