---
phase: 06-subscription-billing
plan: 02
type: execute
wave: 1
depends_on: []
files_modified: [src/contexts/SubscriptionContext.tsx, src/lib/firebase/firestore.ts, src/app/layout.tsx, src/hooks/useChat.ts]
autonomous: true
---

<objective>
Create SubscriptionContext for app-wide subscription state and implement trial start logic.

Purpose: Components need to know user's subscription status (trial, active, expired) to gate features and show appropriate UI.
Output: SubscriptionContext provider with real-time Firestore sync, trial starts on first chat message.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-subscription-billing/06-CONTEXT.md

@src/contexts/AuthContext.tsx
@src/lib/firebase/firestore.ts
@src/hooks/useChat.ts
@src/app/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend Firestore types and add subscription helpers</name>
  <files>src/lib/firebase/firestore.ts</files>
  <action>
Extend firestore.ts with subscription-related types and functions:

1. Add/update types:
```typescript
interface UserSubscription {
  status: 'active' | 'canceled' | 'past_due' | 'expired';
  stripeSubscriptionId: string;
  priceId: string;
  currentPeriodEnd: Date;
  cancelAtPeriodEnd: boolean;
}

interface UserDocument {
  // Existing profile fields
  userRole?: string;
  companySize?: string;
  topic?: string;
  updatedAt?: Date;

  // Subscription fields
  createdAt?: Date;
  trialStartedAt?: Date;
  stripeCustomerId?: string;
  subscription?: UserSubscription;
}
```

2. Add function to get full user document (not just profile):
```typescript
export async function getUserDocument(uid: string): Promise<UserDocument | null>
```

3. Add function to start trial:
```typescript
export async function startTrial(uid: string): Promise<void>
// Sets trialStartedAt to now if not already set
// Uses setDoc with merge: true
```

4. Add function to check subscription status:
```typescript
export type AccessStatus = 'allowed' | 'trial_expired' | 'subscription_expired' | 'pre_trial';

export function getAccessStatus(user: UserDocument | null): AccessStatus
// Returns 'pre_trial' if user is null or has no trialStartedAt
// Returns 'allowed' if in trial period (within 7 days) or has active/canceled subscription with valid period
// Returns 'trial_expired' if trial ended and no subscription
// Returns 'subscription_expired' if subscription period ended
```

Keep existing functions (saveUserProfile, getUserProfile) for backward compatibility.
  </action>
  <verify>Build passes: `npm run build`</verify>
  <done>Types and helper functions for subscription management exported.</done>
</task>

<task type="auto">
  <name>Task 2: Create SubscriptionContext</name>
  <files>src/contexts/SubscriptionContext.tsx, src/app/layout.tsx</files>
  <action>
1. Create `src/contexts/SubscriptionContext.tsx`:

```typescript
interface SubscriptionContextValue {
  status: 'loading' | AccessStatus;
  userDoc: UserDocument | null;
  trialDaysLeft: number | null;
  isSubscribed: boolean;
  refreshSubscription: () => Promise<void>;
}
```

Implementation:
- Use `useAuth()` to get current user
- Set up Firestore `onSnapshot` listener on `users/{uid}` document for real-time updates
- Calculate `trialDaysLeft` from `trialStartedAt` (null if no trial or subscribed)
- Calculate `isSubscribed` (has active/canceled subscription with valid period)
- `status` starts as 'loading', then updates based on `getAccessStatus()`
- Clean up listener on unmount

Export `useSubscription()` hook.

2. Update `src/app/layout.tsx`:
- Import SubscriptionProvider
- Wrap app with SubscriptionProvider (inside AuthProvider)
  </action>
  <verify>Build passes: `npm run build`</verify>
  <done>SubscriptionContext provides real-time subscription status app-wide.</done>
</task>

<task type="auto">
  <name>Task 3: Start trial on first chat message</name>
  <files>src/hooks/useChat.ts</files>
  <action>
Modify `useChat.ts` to start trial on first message:

1. Import `startTrial` from firestore.ts
2. Import `useAuth` from AuthContext
3. In the `sendMessage` function, before making the API call:
   - If user is authenticated, call `await startTrial(user.uid)`
   - This is idempotent (startTrial only sets trialStartedAt if not already set)
   - Don't block on this - can be fire-and-forget with error logging

This ensures trial starts when user sends their first chat message, not on signup.
  </action>
  <verify>Build passes: `npm run build`</verify>
  <done>Trial automatically starts when authenticated user sends first chat message.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] SubscriptionContext exported and wrapped in layout
- [ ] useSubscription hook available
- [ ] startTrial called on first chat message
- [ ] Real-time Firestore listener updates context
</verification>

<success_criteria>

- All tasks completed
- SubscriptionContext provides status, trialDaysLeft, isSubscribed
- Trial starts on first chat message (not on signup)
- Context updates in real-time when Firestore changes
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/06-subscription-billing/06-02-SUMMARY.md`
</output>
