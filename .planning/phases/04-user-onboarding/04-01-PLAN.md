---
phase: 04-user-onboarding
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [package.json, src/lib/firebase/config.ts, src/lib/firebase/auth.ts, src/contexts/AuthContext.tsx, src/app/providers.tsx, src/app/sign-in/page.tsx]
autonomous: true
user_setup:
  - service: firebase
    why: "Authentication requires Firebase project configuration"
    env_vars:
      - name: NEXT_PUBLIC_FIREBASE_API_KEY
        source: "Firebase Console → Project Settings → General → Web app → apiKey"
      - name: NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN
        source: "Firebase Console → Project Settings → General → Web app → authDomain"
      - name: NEXT_PUBLIC_FIREBASE_PROJECT_ID
        source: "Firebase Console → Project Settings → General → Web app → projectId"
    dashboard_config:
      - task: "Enable Google sign-in provider"
        location: "Firebase Console → Authentication → Sign-in method → Google → Enable"
      - task: "Enable Email link (passwordless) sign-in"
        location: "Firebase Console → Authentication → Sign-in method → Email/Password → Enable Email link"
      - task: "Add authorized domain for magic links"
        location: "Firebase Console → Authentication → Settings → Authorized domains → Add localhost and production domain"
---

<objective>
Set up Firebase Auth with Google OAuth and magic link sign-in.

Purpose: Enable user authentication before accessing chat functionality.
Output: Working sign-in page with Google and magic link options.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-user-onboarding/04-CONTEXT.md

@src/app/providers.tsx
@src/app/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Firebase and create configuration</name>
  <files>package.json, src/lib/firebase/config.ts</files>
  <action>
Install firebase package: `npm install firebase`

Create `src/lib/firebase/config.ts`:
- Import firebase/app and firebase/auth
- Create firebaseConfig object reading from NEXT_PUBLIC_FIREBASE_* env vars
- Initialize app with getApps().length check to prevent re-initialization
- Export auth instance from getAuth(app)
- Export app instance

Use lazy initialization pattern (only init when imported, not at build time).
  </action>
  <verify>npm run build succeeds, no TypeScript errors</verify>
  <done>Firebase installed, config exports auth and app instances</done>
</task>

<task type="auto">
  <name>Task 2: Create AuthContext provider</name>
  <files>src/contexts/AuthContext.tsx, src/app/providers.tsx</files>
  <action>
Create `src/contexts/AuthContext.tsx`:
- 'use client' directive
- AuthContext with: user (User | null), loading (boolean), signOut function
- useAuth hook that throws if used outside provider
- AuthProvider component that:
  - Uses onAuthStateChanged to track auth state
  - Sets loading=true initially, false after first auth check
  - Provides signOut function wrapping Firebase signOut

Update `src/app/providers.tsx`:
- Import AuthProvider
- Wrap children with AuthProvider (inside ThemeProvider is fine)
  </action>
  <verify>npm run build succeeds, no TypeScript errors</verify>
  <done>AuthContext provides user, loading, signOut; wrapped in providers.tsx</done>
</task>

<task type="auto">
  <name>Task 3: Create sign-in page with Google OAuth and magic link</name>
  <files>src/lib/firebase/auth.ts, src/app/sign-in/page.tsx</files>
  <action>
Create `src/lib/firebase/auth.ts`:
- signInWithGoogle(): Uses GoogleAuthProvider + signInWithPopup
- sendMagicLink(email, actionCodeSettings): Uses sendSignInLinkToEmail, stores email in localStorage for verification
- completeMagicLinkSignIn(): Uses isSignInWithEmailLink + signInWithEmailLink, retrieves email from localStorage

Create `src/app/sign-in/page.tsx`:
- 'use client' directive
- Minimal centered card design (per CONTEXT.md: clean card with just auth buttons)
- Logo at top (same scale icon as home page header)
- "Prisijungti" heading
- Google sign-in button (primary, full width)
- Divider with "arba"
- Email input + "Siųsti prisijungimo nuorodą" button for magic link
- Loading states for both methods
- Error display if auth fails
- On successful sign-in, redirect to '/' (onboarding) or '/chat' if context exists
- Handle magic link callback: check isSignInWithEmailLink on mount, complete sign-in if true

Style: Use existing Tailwind classes from the codebase. Match the card/border/shadow patterns from page.tsx.
  </action>
  <verify>npm run dev, visit /sign-in, page renders without errors</verify>
  <done>Sign-in page shows Google button and magic link form, both methods functional</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npm run dev` starts without errors
- [ ] /sign-in page renders with Google button and email form
- [ ] No TypeScript errors
</verification>

<success_criteria>

- Firebase installed and configured
- AuthContext provides user state app-wide
- Sign-in page renders with both auth methods
- Google sign-in opens popup (will fail without Firebase config, expected)
- Magic link shows success message after sending (will fail without Firebase config, expected)
</success_criteria>

<output>
After completion, create `.planning/phases/04-user-onboarding/04-01-SUMMARY.md`
</output>
