---
phase: 04-user-onboarding
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified: [src/app/page.tsx, src/app/chat/page.tsx, src/app/sign-in/page.tsx]
autonomous: false
---

<objective>
Gate chat access behind authentication and wire the complete sign-in flow.

Purpose: Ensure users must sign in before accessing the chat functionality.
Output: Protected routes that redirect unauthenticated users to sign-in.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-user-onboarding/04-CONTEXT.md
@.planning/phases/04-user-onboarding/04-01-SUMMARY.md

@src/contexts/AuthContext.tsx
@src/app/page.tsx
@src/app/chat/page.tsx
@src/app/sign-in/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Gate /chat route with auth check</name>
  <files>src/app/chat/page.tsx</files>
  <action>
Modify `/chat/page.tsx`:
- Import useAuth from AuthContext
- Get { user, loading } from useAuth()
- While loading: show existing loading spinner
- If !user after loading: redirect to /sign-in (using router.push)
- If user but no localStorage context: redirect to / (onboarding)
- If user and has context: render chat as before

Keep existing context check logic, just add auth check before it.
  </action>
  <verify>npm run build succeeds</verify>
  <done>/chat redirects to /sign-in when not authenticated</done>
</task>

<task type="auto">
  <name>Task 2: Update onboarding page to require auth</name>
  <files>src/app/page.tsx</files>
  <action>
Modify `/page.tsx` (onboarding):
- Import useAuth from AuthContext
- Get { user, loading } from useAuth()
- While loading: show centered loading spinner (simple, minimal)
- If !user: redirect to /sign-in
- If user: show onboarding flow as before

The onboarding still stores context in localStorage - this is fine.
After onboarding completes, it redirects to /chat which now requires auth (already satisfied).
  </action>
  <verify>npm run build succeeds</verify>
  <done>Onboarding page requires auth, redirects to /sign-in if not authenticated</done>
</task>

<task type="auto">
  <name>Task 3: Update sign-in page redirects</name>
  <files>src/app/sign-in/page.tsx</files>
  <action>
Modify `/sign-in/page.tsx`:
- Import useAuth
- Get { user, loading } from useAuth()
- If user already signed in: redirect to '/' (they'll go through onboarding or to chat)
- This prevents signed-in users from seeing sign-in page

Flow after sign-in success:
- Google/magic link completes → onAuthStateChanged fires → user state updates
- useEffect detects user → redirects to '/'
- '/' checks auth (passes) → checks localStorage context
  - No context: shows onboarding
  - Has context: redirects to /chat
  </action>
  <verify>npm run build succeeds</verify>
  <done>Sign-in page redirects authenticated users away</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete auth flow: sign-in → onboarding → chat with route protection</what-built>
  <how-to-verify>
    1. Ensure Firebase env vars are set in .env.local
    2. Run: npm run dev
    3. Visit: http://localhost:3000
       - Should redirect to /sign-in (not authenticated)
    4. Click Google sign-in button
       - Should open popup, complete auth
       - Should redirect to / (onboarding)
    5. Complete onboarding (role, size, topic)
       - Should redirect to /chat
    6. Open new incognito window, visit /chat directly
       - Should redirect to /sign-in (no auth)
    7. Sign in again in incognito
       - Should go to onboarding (no localStorage context)
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] Unauthenticated user visiting / → redirected to /sign-in
- [ ] Unauthenticated user visiting /chat → redirected to /sign-in
- [ ] Authenticated user visiting /sign-in → redirected to /
- [ ] Full flow works: sign-in → onboarding → chat
</verification>

<success_criteria>

- All routes properly protected
- Auth state persists across page refreshes
- Flow is smooth: sign-in → onboarding → chat
- No anonymous access to chat
- User approved the flow in checkpoint
</success_criteria>

<output>
After completion, create `.planning/phases/04-user-onboarding/04-02-SUMMARY.md`
</output>
