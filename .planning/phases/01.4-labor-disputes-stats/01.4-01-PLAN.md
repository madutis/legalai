# Plan 01.4-01: Labor Disputes Statistics Integration

## Objective
Add VDI labor dispute outcome statistics to LLM context for evidence-based guidance on dispute likelihood and outcomes.

## Context
- Data: 13 CSV files (2013-2025) with ~86k cases in `/data/open-data/16_dg_*.csv`
- No RAG/embeddings - static statistics block in system prompt
- Citation format: "VDI DGK duomenys (2013-2025)"

## Tasks

### 1. Create Statistics Processing Script
**File:** `scripts/process-labor-disputes.ts`

**Input:** All 16_dg_*.csv files (tab-separated)

**Output:** `data/processed/labor-disputes-stats.json`

**Statistics to compute:**

```typescript
interface LaborDisputeStats {
  meta: {
    totalCases: number;
    yearRange: string; // "2013-2025"
    lastUpdated: string;
  };

  // Overall outcome distribution
  outcomes: {
    tenkinamaPilnai: { count: number; pct: number };
    tenkinamaDalies: { count: number; pct: number };
    atmesta: { count: number; pct: number };
    taikosSutartis: { count: number; pct: number };
    atsisakyta: { count: number; pct: number };
    other: { count: number; pct: number };
  };

  // By claim type (top 10)
  byClaimType: Array<{
    claimType: string; // e.g., "dėl darbo užmokesčio"
    count: number;
    pct: number;
    outcomes: {
      tenkinamaPilnai: number;
      tenkinamaDalies: number;
      atmesta: number;
      taikosSutartis: number;
    };
    avgAmountAwarded?: number;
  }>;

  // By industry (top 15)
  byIndustry: Array<{
    industry: string; // EVRK description
    count: number;
    outcomes: {
      tenkinamaPilnai: number;
      tenkinamaDalies: number;
      atmesta: number;
    };
  }>;

  // Amounts (for wage claims only)
  amounts: {
    avgAwarded: number;
    medianAwarded: number;
    p25: number;
    p75: number;
  };
}
```

**Implementation:**
- Use `csv-parse` for parsing (already in deps)
- Accumulate stats across all years
- Map DGSP_PAV values to canonical outcomes
- Parse SUMOS2 for amounts (complex format: "Type; claimed; awarded; ...")
- Filter by completed cases only (PBUS_PAV = "Užbaigtas")

### 2. Update System Prompt
**File:** `src/lib/gemini/index.ts`

**Add block after existing citation instructions:**

```typescript
const LABOR_DISPUTE_STATS = `
<darbo_ginčų_statistika>
Pagal VDI darbo ginčų komisijų duomenis (2013-2025, ${stats.meta.totalCases.toLocaleString('lt-LT')} bylų):

BENDROJI STATISTIKA:
- Darbuotojo naudai pilnai: ${stats.outcomes.tenkinamaPilnai.pct}%
- Darbuotojo naudai iš dalies: ${stats.outcomes.tenkinamaDalies.pct}%
- Darbdavio naudai (atmesta): ${stats.outcomes.atmesta.pct}%
- Taikos sutartis: ${stats.outcomes.taikosSutartis.pct}%

PAGAL GINČO TIPĄ:
${stats.byClaimType.slice(0, 5).map(c =>
  `- ${c.claimType}: ${c.pct}% visų ginčų, laimėjimo tikimybė ${c.outcomes.tenkinamaPilnai + c.outcomes.tenkinamaDalies}%`
).join('\n')}

VIDUTINĖS PRITEISTOS SUMOS (darbo užmokesčio ginčai):
- Vidurkis: ${stats.amounts.avgAwarded.toLocaleString('lt-LT')} EUR
- Mediana: ${stats.amounts.medianAwarded.toLocaleString('lt-LT')} EUR

Kai vartotojas klausia apie ginčo tikimybę ar galimą baigtį, naudok šią statistiką ir cituok "VDI DGK duomenys".
</darbo_ginčų_statistika>
`;
```

**Modify SYSTEM_PROMPT to include:**
- Import stats from JSON at build time OR
- Inline the formatted stats string (simpler, ~500 chars)

### 3. Add Citation Guidance
**File:** `src/lib/gemini/index.ts`

**Update citation instructions in SYSTEM_PROMPT:**

Add to the "Kaip cituoti" section:
```
- VDI DGK STATISTIKA: Kai kalbi apie ginčų baigčių tikimybes, sakyk "Pagal VDI DGK duomenis (86 tūkst. bylų, 2013-2025)..."
```

### 4. Test Script
**File:** `scripts/process-labor-disputes.ts`

Run with:
```bash
npx tsx scripts/process-labor-disputes.ts
npx tsx scripts/process-labor-disputes.ts --dry-run  # Preview only
```

Verify:
- JSON output is valid
- Percentages sum to ~100%
- Amounts are reasonable (1000-5000 EUR range)

## Files Changed

| File | Change |
|------|--------|
| `scripts/process-labor-disputes.ts` | NEW - Statistics processing script |
| `data/processed/labor-disputes-stats.json` | NEW - Computed statistics |
| `src/lib/gemini/index.ts` | ADD stats block to SYSTEM_PROMPT |

## Verification

1. Run script: `npx tsx scripts/process-labor-disputes.ts`
2. Check JSON output has expected structure
3. Local test: Ask "kokia tikimybė laimėti ginčą dėl neišmokėto atlyginimo?"
4. Response should cite VDI DGK statistics with specific percentages

## Not In Scope
- Pinecone/embeddings for individual cases
- Real-time stats updates
- Per-case citations
- Industry-specific search filters

## Dependencies
- `csv-parse` (already in package.json)
- No new dependencies needed

## Estimated Duration
~30 min
