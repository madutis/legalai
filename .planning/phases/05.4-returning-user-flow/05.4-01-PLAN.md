---
phase: 05.4-returning-user-flow
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/app/page.tsx]
autonomous: true
---

<objective>
Optimize the onboarding flow for returning users by detecting saved profile data and skipping completed steps.

Purpose: Users with saved role and company size should land directly on topic selection (step 3), reducing friction for repeat consultations.
Output: Enhanced onboarding page that detects returning users and shows their saved selections in the step indicator.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05.4-returning-user-flow/05.4-CONTEXT.md

@src/app/page.tsx
@src/lib/firebase/firestore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Detect saved profile and auto-advance to step 3</name>
  <files>src/app/page.tsx</files>
  <action>
Add useEffect to check for saved profile on mount:
1. If user is authenticated, call `getUserProfile(user.uid)` to load Firestore profile
2. If profile exists with userRole and companySize, set initial step to 3 and populate data state
3. First-time users (no profile or incomplete) continue to see step 1

Import `getUserProfile` from firestore.ts. Use existing `useAuth` hook for user.
Handle loading state while checking profile (brief spinner or skeleton).

Do NOT check localStorage - always use Firestore for returning user detection since profile persistence was implemented in Phase 5.
  </action>
  <verify>
Manual test:
1. Sign in as user with saved profile in Firestore
2. Navigate to homepage
3. Confirm page loads directly on step 3 (topic selection)
4. Sign out, clear session, confirm new user sees step 1
  </verify>
  <done>Returning users with saved role+companySize land on step 3. New users see step 1.</done>
</task>

<task type="auto">
  <name>Task 2: Enhance step indicator with selected values</name>
  <files>src/app/page.tsx</files>
  <action>
Modify the step indicator (lines 244-267) to show selected values:

1. For completed steps (s < step), show the selected label next to step number:
   - Step 1: Show role label (e.g., "1: Darbdavys") from ROLES array
   - Step 2: Show company size label (e.g., "2: 10-50") from COMPANY_SIZES array

2. Make completed steps clickable to navigate back:
   - Already partially implemented (onClick={() => s < step && setStep(s)})
   - Add visual hover state to indicate clickability (cursor-pointer, underline on hover)

3. Add small edit icon or underline on hover to indicate steps are editable

Keep current styling for active step (scale-110, shadow-md).
Use text-xs or text-[10px] for the label to fit within/below the circle.

Layout options (pick simpler one):
- Show label below circle: "1" with "Darbdavys" underneath
- Show label inline after circle: "1: Darbdavys"
  </action>
  <verify>
Visual inspection:
1. Complete step 1 (select role)
2. Confirm step indicator shows "1: [selected role]" or role label below
3. Hover over completed step, confirm clickable appearance
4. Click completed step, confirm navigation back works
  </verify>
  <done>Completed steps show selected value labels. Clickable appearance is clear.</done>
</task>

<task type="auto">
  <name>Task 3: Update Firestore when user changes saved values</name>
  <files>src/app/page.tsx</files>
  <action>
When returning user changes role or company size (via clicking completed steps):

1. If user is authenticated and changes userRole or companySize, save to Firestore immediately
2. Use existing `saveUserProfile` function with merge: true (already does this)
3. The existing handleSelect already saves on topic selection - ensure role/companySize changes are also persisted when user re-selects

Current flow: handleSelect saves entire data object only when topic is selected.
New flow: When user goes back and changes role/companySize, that change persists to Firestore immediately (on auto-advance to next step).

Simplest approach: In handleSelect, when field is userRole or companySize and user is authenticated, call saveUserProfile with partial update.
  </action>
  <verify>
1. Sign in as returning user (has saved profile)
2. Click step 1 to go back
3. Select different role
4. Complete flow or refresh page
5. Verify Firestore profile shows new role
  </verify>
  <done>Changes to role/companySize persist to Firestore immediately for authenticated users.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] Returning user (with Firestore profile) lands on step 3
- [ ] Step indicator shows selected values for completed steps
- [ ] Clicking completed step navigates back and allows re-selection
- [ ] Changed values persist to Firestore
- [ ] New users (no profile) see full 3-step flow as before
</verification>

<success_criteria>

- All tasks completed
- Returning users skip to topic selection (step 3)
- Previously selected values visible in step indicator
- Easy to change saved values by clicking completed steps
- No regression for new user flow
</success_criteria>

<output>
After completion, create `.planning/phases/05.4-returning-user-flow/05.4-01-SUMMARY.md`
</output>
