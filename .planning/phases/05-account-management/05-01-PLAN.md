---
phase: 05-account-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/firebase/config.ts
  - src/lib/firebase/firestore.ts
  - src/app/page.tsx
  - src/app/chat/page.tsx
  - src/app/account/page.tsx
autonomous: true
---

<objective>
Persist user profiling to Firestore and create minimal /account page.

Purpose: User context (role, company size, topic) follows them across sessions/devices. New chats automatically inherit saved profile.
Output: Firestore user profile service, updated onboarding/chat flows, minimal account page.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-user-onboarding/04-01-SUMMARY.md
@.planning/phases/04-user-onboarding/04-02-SUMMARY.md
@.planning/phases/05-account-management/05-CONTEXT.md

@src/lib/firebase/config.ts
@src/lib/firebase/auth.ts
@src/contexts/AuthContext.tsx
@src/app/page.tsx
@src/app/chat/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Firestore service for user profiles</name>
  <files>src/lib/firebase/config.ts, src/lib/firebase/firestore.ts</files>
  <action>
1. Update config.ts to add Firestore initialization:
   - Add lazy `getFirebaseFirestore()` function following existing auth pattern
   - Export Firestore type

2. Create firestore.ts with user profile functions:
   - Define `UserProfile` interface: { userRole: string, companySize: string, topic: string, updatedAt: Date }
   - `saveUserProfile(uid: string, profile: UserProfile)` - sets doc at `users/{uid}`
   - `getUserProfile(uid: string): Promise<UserProfile | null>` - gets doc, returns null if not exists
   - Use merge: true on set to preserve any future fields

Collection path: `users/{uid}` with profile data directly in document.
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>Firestore config exported, user profile save/load functions exist</done>
</task>

<task type="auto">
  <name>Task 2: Update onboarding and chat to use Firestore</name>
  <files>src/app/page.tsx, src/app/chat/page.tsx</files>
  <action>
**Onboarding (page.tsx):**
- Import `saveUserProfile` and `useAuth`
- After profiling complete (handleSelect for topic):
  - If user authenticated: save to Firestore AND localStorage
  - If not authenticated: save to localStorage only (sign-in flow will sync)
- Keep localStorage write for immediate redirect (Firestore is async backup)

**Chat (chat/page.tsx):**
- Import `getUserProfile`
- On mount (after auth verified):
  - Try load from Firestore first
  - If Firestore has profile: use it, sync to localStorage
  - If Firestore empty but localStorage has context: migrate to Firestore, then use
  - If neither: redirect to onboarding

**Sign-in flow update (sign-in/page.tsx):**
- After successful auth, if localStorage has context but Firestore doesn't:
  - Migrate localStorage context to Firestore
  - This handles the case where user profiled → signed up → now has account

This ensures:
1. Existing localStorage users migrate seamlessly
2. New users get Firestore persistence
3. Context available across devices after sync
  </action>
  <verify>
1. `npm run build` succeeds
2. Flow: profile → sign-in → chat loads context
3. Second device: sign-in → chat loads context from Firestore
  </verify>
  <done>User context persisted to Firestore, migrated from localStorage if exists</done>
</task>

<task type="auto">
  <name>Task 3: Create minimal /account page</name>
  <files>src/app/account/page.tsx</files>
  <action>
Create `/account` route with minimal UI:
- Require auth (redirect to /sign-in if not authenticated)
- Display user email from `useAuth().user.email`
- Sign out button using `useAuth().signOut()` → redirect to /
- Link back to /chat
- Simple card layout matching existing design system (bg-card, border-border, rounded-xl)
- Header with LegalAI logo and ThemeToggle (consistent with other pages)

Keep it minimal - Phase 6 (billing) will extend this page.

UI structure:
```
Header: LegalAI logo | ThemeToggle
Card:
  - Email: user@example.com
  - [Sign Out button]
  - [Back to Chat link]
```
  </action>
  <verify>
1. `npm run build` succeeds
2. Visit /account when authenticated → see email and sign out
3. Click sign out → redirected to / and signed out
  </verify>
  <done>/account page shows email and sign out, redirects if not authenticated</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds
- [ ] `npx tsc --noEmit` passes
- [ ] Onboarding saves to Firestore when authenticated
- [ ] Chat loads from Firestore, falls back to localStorage
- [ ] /account page displays email and sign out works
- [ ] No console errors during flows
</verification>

<success_criteria>
- All tasks completed
- User profile persists to Firestore
- New chats inherit saved context
- /account page functional (email + sign out)
- Existing localStorage users migrated transparently
</success_criteria>

<output>
After completion, create `.planning/phases/05-account-management/05-01-SUMMARY.md`
</output>
